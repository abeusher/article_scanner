#!/usr/bin/env python3

import re
import requests
import sqlite3
import time
import sys
import csv


conn = sqlite3.connect('news.db')
c = conn.cursor()
c.execute("CREATE TABLE IF NOT EXISTS story (id INTEGER PRIMARY KEY, url TEXT, retrieved_utc INTEGER, html TEXT)")
conn.commit()

def findWholeWord(w):
    return re.compile(r'\b({0})\b'.format(w), flags=re.IGNORECASE).search

def get_page(url,story_id,refetch=False):
    c.execute("SELECT id FROM story WHERE id = ?",(story_id,))
    id = c.fetchone()
    if id and not refetch:
        print("Prefetch is false and already have url: {}".format(url))
        return
    headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
    r = requests.get(url,headers=headers)
    retrieved_utc = int(time.time())
    if r.status_code == 200:
        try:
            c.execute("INSERT INTO story VALUES (?,?,?,?)",(story_id,url,retrieved_utc,r.content))
            conn.commit()
        except:
            sys.exit("Something went wrong with the sqlite3 insert")
        else:
            print("Successfully fetched url: {}".format(url))
    else:
        print("Issue fectching {}".format(url))
        return

def get_stories():
    lines = csv.reader([line.rstrip('\n') for line in open("data")])
    for idx,line in enumerate(lines):
        if idx == 0: continue # Skip header line
        story_id = line[0]
        url = line[3]
        get_page(url,story_id)

def scan_stories():
    terms = [line.rstrip('\n') for line in open("terms") if len(line) > 2]
    print (terms)
    c.execute("SELECT id, url, html FROM story")
    stories = c.fetchall()
    for story in stories:
        print(
        id = story[0]
        url = story[1]
        html = story[2]
        for term in terms:
            test = findWholeWord(term)(html.decode())
            if test is not None:
                print(test.start())
                print ("Story id: {} contains \"{}\" used in this context: {}".format(id,term,''))

#get_stories()
scan_stories()
